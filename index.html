<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Gestione Ombrelloni</title>
  <style>
    html, body { margin:0; padding:0; overflow:hidden; font-family:sans-serif; background:#f4e7c5; user-select:none; }
    #map-wrapper { width:100vw; height:100vh; position:relative; overflow:hidden; touch-action:none; }
    #map { width:100%; height:100%; position:absolute; top:0; left:0; transform-origin:center center; }
    .umbrella { width:140px; height:140px; border-radius:50%; position:absolute; display:flex;
      justify-content:center; align-items:center; font-size:40px; font-weight:bold; color:#000;
      border:2px solid #333; background:gray; text-align:center; padding:10px;
      cursor:grab; touch-action:none; box-sizing:border-box; }
    .umbrella.open { background:green; }
    .umbrella.closed { background:red; }
    .delete-btn { position:absolute; top:2px; right:4px; cursor:pointer; font-size:18px;
      color:black; user-select:none; z-index:1; padding:5px; background:rgba(255,255,255,0.8);
      border-radius:50%; width:30px; height:30px; display:flex; align-items:center; justify-content:center; }
    .date-label { position:absolute; bottom:2px; font-size:10px; width:100%; text-align:center; pointer-events:none; }
    #zoom-controls { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); z-index:1000;
      background:rgba(255,255,255,0.9); padding:10px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.2);
      display:flex; align-items:center; gap:10px; }
    #zoom-slider { width:200px; }
    #zoom-value { font-weight:bold; min-width:40px; text-align:center; }
    #modal-backdrop { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh;
      background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:2000; }
    #edit-modal { background:white; padding:20px; border-radius:8px; min-width:300px; max-width:90vw;
      box-shadow:0 0 10px rgba(0,0,0,0.5); }
    #edit-modal h3 { margin-top:0; }
    #edit-modal label { display:block; margin:15px 0 5px; font-weight:bold; }
    #edit-modal input[type="number"] { width:100%; padding:10px; font-size:16px;
      border:1px solid #ccc; border-radius:4px; }
    #edit-modal input[type="checkbox"] { margin-right:8px; transform:scale(1.2); }
    #edit-modal-buttons { margin-top:20px; text-align:right; }
    #edit-modal-buttons button { margin-left:10px; padding:10px 20px; font-size:16px; border:none;
      border-radius:4px; cursor:pointer; }
    #cancel-btn { background:#f0f0f0; color:#333; }
    #save-btn { background:#007bff; color:white; }
    #cancel-btn:hover { background:#e0e0e0; }
    #save-btn:hover { background:#0056b3; }
    #instructions { position:fixed; top:10px; left:10px; background:rgba(255,255,255,0.9);
      padding:10px; border-radius:5px; font-size:12px; z-index:1000; max-width:200px; }
  </style>
</head>
<body>
  <div id="instructions">
    <strong>Istruzioni:</strong><br>
    ‚Ä¢ Doppio tap (mobile) o doppio click (desktop): crea ombrellone<br>
    ‚Ä¢ Trascina per spostare<br>
    ‚Ä¢ Pinch-to-zoom con due dita<br>
    ‚Ä¢ üóëÔ∏è per eliminare
  </div>
  <div id="map-wrapper"><div id="map"></div></div>
  <div id="zoom-controls">
    <span>Zoom:</span>
    <input type="range" id="zoom-slider" min="0.1" max="2" step="0.05" value="1" />
    <span id="zoom-value">1.00x</span>
  </div>

  <div id="modal-backdrop">
    <div id="edit-modal">
      <h3>Modifica Ombrellone</h3>
      <label for="lettini-input">Numero lettini:</label>
      <input type="number" id="lettini-input" min="0" max="10">
      <label><input type="checkbox" id="open-checkbox"> Ombrellone aperto</label>
      <div id="edit-modal-buttons">
        <button id="cancel-btn">Annulla</button>
        <button id="save-btn">Salva</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAxqgScWEda7AoGWxWkFBCgVFjDvMks5SU",
      authDomain: "ombrelloni-ee9aa.firebaseapp.com",
      databaseURL: "https://ombrelloni-ee9aa-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "ombrelloni-ee9aa",
      storageBucket: "ombrelloni-ee9aa.appspot.com",
      messagingSenderId: "781899782985",
      appId: "1:781899782985:web:a0c2039509531c9c1898"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const mapWrapper = document.getElementById('map-wrapper');
    const map = document.getElementById('map');
    const zoomSlider = document.getElementById('zoom-slider');
    const zoomValue = document.getElementById('zoom-value');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const lettiniInput = document.getElementById('lettini-input');
    const openCheckbox = document.getElementById('open-checkbox');
    const cancelBtn = document.getElementById('cancel-btn');
    const saveBtn = document.getElementById('save-btn');

    let umbrellas = [], currentEl = null;
    let zoomLevel = 1, mapOffsetX = 0, mapOffsetY = 0;
    let lastTapOrClickTime = 0;
    let pinchStartDist = null;

    function updateMapTransform() {
      map.style.transform = `translate(${mapOffsetX}px, ${mapOffsetY}px) scale(${zoomLevel})`;
      zoomValue.textContent = zoomLevel.toFixed(2) + 'x';
    }

    zoomSlider.addEventListener('input', e => {
      const oldZoom = zoomLevel;
      zoomLevel = parseFloat(e.target.value);
      const rect = mapWrapper.getBoundingClientRect();
      const centerX = rect.width / 2, centerY = rect.height / 2;
      const mapCenterX = (centerX - mapOffsetX) / oldZoom;
      const mapCenterY = (centerY - mapOffsetY) / oldZoom;
      mapOffsetX = centerX - mapCenterX * zoomLevel;
      mapOffsetY = centerY - mapCenterY * zoomLevel;
      updateMapTransform();
    });

    function handleDoubleTapOrClick(xClient, yClient) {
      const now = Date.now();
      if (now - lastTapOrClickTime < 400) {
        const rect = mapWrapper.getBoundingClientRect();
        const x = (xClient - rect.left - mapOffsetX) / zoomLevel;
        const y = (yClient - rect.top - mapOffsetY) / zoomLevel;
        const id = now + Math.random();
        const newUmbrella = { id, lettini: '2', open: false, x: Math.round(x), y: Math.round(y), mtime: now };
        umbrellas.push(newUmbrella);
        set(ref(db, `umbrellas/${id}`), newUmbrella);
        createUmbrella(newUmbrella);
        lastTapOrClickTime = 0;
      } else {
        lastTapOrClickTime = now;
      }
    }

    mapWrapper.addEventListener('click', e => {
      if (e.target.closest('.umbrella')) return;
      e.preventDefault(); e.stopPropagation();
      handleDoubleTapOrClick(e.clientX, e.clientY);
    });

    mapWrapper.addEventListener('touchend', e => {
      if (e.touches.length > 0 || e.target.closest('.umbrella')) return;
      const touch = e.changedTouches[0];
      handleDoubleTapOrClick(touch.clientX, touch.clientY);
    });

    mapWrapper.addEventListener('touchmove', e => {
      if (e.touches.length === 2) {
        e.preventDefault();
        const [t1, t2] = e.touches;
        const dist = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
        if (pinchStartDist === null) { pinchStartDist = dist; return; }
        const delta = dist - pinchStartDist;
        const oldZoom = zoomLevel;
        zoomLevel = Math.max(0.1, Math.min(2, zoomLevel + delta * 0.002));
        zoomSlider.value = zoomLevel.toFixed(2);
        const rect = mapWrapper.getBoundingClientRect();
        const centerX = rect.width / 2, centerY = rect.height / 2;
        const mapCenterX = (centerX - mapOffsetX) / oldZoom;
        const mapCenterY = (centerY - mapOffsetY) / oldZoom;
        mapOffsetX = centerX - mapCenterX * zoomLevel;
        mapOffsetY = centerY - mapCenterY * zoomLevel;
        updateMapTransform();
        pinchStartDist = dist;
      }
    }, { passive: false });

    mapWrapper.addEventListener('touchend', e => {
      if (e.touches.length < 2) pinchStartDist = null;
    });

    function createUmbrella(u) {
      const el = document.createElement('div');
      el.className = 'umbrella';
      el.style.left = u.x + 'px';
      el.style.top = u.y + 'px';
      el.dataset.id = u.id;
      el.dataset.lettini = u.lettini;
      el.dataset.open = u.open;
      el.dataset.mtime = u.mtime;
      map.appendChild(el);
      render(el);
    }

    function render(el) {
      const lettini = el.dataset.lettini;
      const open = el.dataset.open === 'true';
      const date = new Date(parseInt(el.dataset.mtime));
      el.classList.toggle('open', open);
      el.classList.toggle('closed', !open);
      el.innerHTML = '';
      const deleteBtn = document.createElement('div');
      deleteBtn.className = 'delete-btn'; deleteBtn.title = 'Elimina'; deleteBtn.textContent = 'üóëÔ∏è';
      const dateLabel = document.createElement('div');
      dateLabel.className = 'date-label';
      dateLabel.textContent = date.toLocaleString('it-IT', { day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit' });
      el.appendChild(deleteBtn); el.appendChild(dateLabel);
      el.appendChild(document.createTextNode(lettini));
      addListeners(el);
    }

    function addListeners(el) {
      let isDragging = false, dragStart = 0;
      el.addEventListener('mousedown', e => {
        if (e.target.classList.contains('delete-btn')) return;
        e.preventDefault(); e.stopPropagation();
        isDragging = false; dragStart = Date.now();
        const startX = e.clientX, startY = e.clientY;
        const origX = parseInt(el.style.left), origY = parseInt(el.style.top);
        const move = ev => {
          const dx = ev.clientX - startX, dy = ev.clientY - startY;
          if (Math.abs(dx)>5 || Math.abs(dy)>5) isDragging = true;
          if (isDragging) {
            el.style.left = (origX + dx/zoomLevel) + 'px';
            el.style.top  = (origY + dy/zoomLevel) + 'px';
          }
        };
        const up = () => {
          document.removeEventListener('mousemove', move);
          document.removeEventListener('mouseup', up);
          if (isDragging) {
            const idx = umbrellas.findIndex(u=>u.id==el.dataset.id);
            if(idx>=0) {
              umbrellas[idx].x = parseInt(el.style.left);
              umbrellas[idx].y = parseInt(el.style.top);
              umbrellas[idx].mtime = Date.now();
              set(ref(db, `umbrellas/${el.dataset.id}`), umbrellas[idx]);
            }
          } else if (Date.now()-dragStart<300) {
            openEditModal(el);
          }
        };
        document.addEventListener('mousemove', move);
        document.addEventListener('mouseup', up);
      });
      el.addEventListener('touchstart', e => {
        if (e.target.classList.contains('delete-btn')) return;
        e.preventDefault(); e.stopPropagation();
        isDragging = false; dragStart = Date.now();
        const touch = e.touches[0];
        const startX = touch.clientX, startY = touch.clientY;
        const origX = parseInt(el.style.left), origY = parseInt(el.style.top);
        const move = ev => {
          if(ev.touches.length!==1) return;
          const t = ev.touches[0];
          const dx = t.clientX - startX, dy = t.clientY - startY;
          if (Math.abs(dx)>5 || Math.abs(dy)>5) isDragging = true;
          if (isDragging) {
            ev.preventDefault();
            el.style.left = (origX + dx/zoomLevel) + 'px';
            el.style.top  = (origY + dy/zoomLevel) + 'px';
          }
        };
        const up = () => {
          document.removeEventListener('touchmove', move);
          document.removeEventListener('touchend', up);
          if (isDragging) {
            const idx = umbrellas.findIndex(u=>u.id==el.dataset.id);
            if(idx>=0) {
              umbrellas[idx].x = parseInt(el.style.left);
              umbrellas[idx].y = parseInt(el.style.top);
              umbrellas[idx].mtime = Date.now();
              set(ref(db, `umbrellas/${el.dataset.id}`), umbrellas[idx]);
            }
          } else if (Date.now()-dragStart<300) {
            openEditModal(el);
          }
        };
        document.addEventListener('touchmove', move, { passive:false });
        document.addEventListener('touchend', up);
      }, { passive:false });

      el.querySelector('.delete-btn').addEventListener('click', e => {
        e.stopPropagation();
        if (confirm('Vuoi eliminare questo ombrellone?')) {
          remove(ref(db, `umbrellas/${el.dataset.id}`));
          el.remove();
          umbrellas = umbrellas.filter(u=>u.id!=el.dataset.id);
        }
      });
    }

    function openEditModal(el) {
      currentEl = el;
      lettiniInput.value = el.dataset.lettini;
      openCheckbox.checked = el.dataset.open==='true';
      modalBackdrop.style.display = 'flex';
    }
    cancelBtn.addEventListener('click', () => { modalBackdrop.style.display='none'; currentEl=null; });
    saveBtn.addEventListener('click', () => {
      if (!currentEl) return;
      currentEl.dataset.lettini = lettiniInput.value||'2';
      currentEl.dataset.open = openCheckbox.checked;
      currentEl.dataset.mtime = Date.now();
      render(currentEl);
      const idx = umbrellas.findIndex(u=>u.id==currentEl.dataset.id);
      if (idx>=0) {
        umbrellas[idx].lettini = currentEl.dataset.lettini;
        umbrellas[idx].open = currentEl.dataset.open;
        umbrellas[idx].mtime = currentEl.dataset.mtime;
        set(ref(db, `umbrellas/${currentEl.dataset.id}`), umbrellas[idx]);
      }
      modalBackdrop.style.display='none'; currentEl=null;
    });
    modalBackdrop.addEventListener('click', e => {
      if (e.target===modalBackdrop) { modalBackdrop.style.display='none'; currentEl=null; }
    });

    function load() {
      onValue(ref(db,'umbrellas'), snapshot => {
        map.innerHTML = ''; umbrellas = [];
        const data = snapshot.val() || {};
        Object.values(data).forEach(u => {
          umbrellas.push(u); createUmbrella(u);
        });
      });
    }

    // Inizia
    updateMapTransform();
    load();

  </script>
</body>
</html>
