<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Gestione Ombrelloni Online</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #f4e7c5;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      user-select: none;
      overflow: hidden;
    }
    #map-container {
      width: 100vw;
      height: 100vh;
      position: relative;
      overflow: hidden;
      cursor: crosshair;
      -webkit-tap-highlight-color: transparent;
    }
    #map {
      width: 200vw;
      height: 200vh;
      position: absolute;
      top: 0;
      left: 0;
      transform-origin: 0 0;
      transition: transform 0.1s ease-out;
      -webkit-tap-highlight-color: transparent;
    }
    .umbrella {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      position: absolute;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 40px;
      font-weight: bold;
      color: #000;
      box-sizing: border-box;
      cursor: grab;
      border: 2px solid #333;
      background-color: gray;
      text-align: center;
      padding: 10px;
      -webkit-tap-highlight-color: transparent;
      touch-action: none;
    }
    .umbrella.open { background-color: green; }
    .umbrella.closed { background-color: red; }
    .delete-btn {
      position: absolute; top: 2px; right: 4px;
      cursor: pointer; font-size: 18px;
      color: black; user-select: none; z-index: 1;
      padding: 5px; background: rgba(255,255,255,0.8);
      border-radius: 50%; width: 30px; height: 30px;
      display: flex; align-items: center; justify-content: center;
    }
    .date-label {
      position: absolute; bottom: 2px;
      font-size: 10px; width: 100%;
      text-align: center; pointer-events: none;
    }
    #zoom-controls {
      position: fixed; top: 20px; right: 20px; z-index: 100;
      display: flex; flex-direction: column; gap: 10px;
    }
    .zoom-btn {
      width: 50px; height: 50px;
      background: rgba(255,255,255,0.9);
      border: 2px solid #333;
      border-radius: 50%;
      font-size: 24px; font-weight: bold; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .zoom-btn:hover { background: rgba(255,255,255,1); }
    #modal-backdrop {
      display: none; position: fixed; top: 0; left: 0;
      width: 100vw; height: 100vh; background: rgba(0,0,0,0.5);
      justify-content: center; align-items: center; z-index: 1000;
      -webkit-tap-highlight-color: transparent;
    }
    #edit-modal {
      background: white; padding: 20px; border-radius: 8px;
      min-width: 300px; max-width: 90vw;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    #edit-modal h3 { margin-top: 0; }
    #edit-modal label { display: block; margin: 15px 0 5px; font-weight: bold; }
    #edit-modal input[type="number"] {
      width: 100%; padding: 10px; font-size: 16px;
      border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
    }
    #edit-modal input[type="checkbox"] {
      margin-right: 8px; transform: scale(1.2);
    }
    #edit-modal-buttons {
      margin-top: 20px; text-align: right;
    }
    #edit-modal-buttons button {
      margin-left: 10px; padding: 10px 20px;
      font-size: 16px; border: none; border-radius: 4px;
      cursor: pointer; -webkit-tap-highlight-color: transparent;
    }
    #cancel-btn { background-color: #f0f0f0; color: #333; }
    #save-btn { background-color: #007bff; color: white; }
    #cancel-btn:hover { background-color: #e0e0e0; }
    #save-btn:hover { background-color: #0056b3; }
  </style>
</head>
<body>
  <div id="map-container"><div id="map"></div></div>
  <div id="zoom-controls">
    <button class="zoom-btn" id="zoom-in">+</button>
    <button class="zoom-btn" id="zoom-out">−</button>
  </div>
  <div id="modal-backdrop">
    <div id="edit-modal">
      <h3>Modifica Ombrellone</h3>
      <label for="lettini-input">Numero lettini:</label>
      <input type="number" id="lettini-input" min="0" max="10">
      <label><input type="checkbox" id="open-checkbox"> Ombrellone aperto</label>
      <div id="edit-modal-buttons">
        <button id="cancel-btn">Annulla</button>
        <button id="save-btn">Salva</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAxqgScWEda7AoGWxWkFBCgVFjDvMks5SU",
      authDomain: "ombrelloni-ee9aa.firebaseapp.com",
      databaseURL: "https://ombrelloni-ee9aa-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "ombrelloni-ee9aa",
      storageBucket: "ombrelloni-ee9aa.appspot.com",
      messagingSenderId: "781899782985",
      appId: "1:781899782985:web:a0c2039509531c1c1898"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const mapContainer = document.getElementById('map-container');
    const map = document.getElementById('map');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const lettiniInput = document.getElementById('lettini-input');
    const openCheckbox = document.getElementById('open-checkbox');
    const cancelBtn = document.getElementById('cancel-btn');
    const saveBtn = document.getElementById('save-btn');
    const zoomInBtn = document.getElementById('zoom-in');
    const zoomOutBtn = document.getElementById('zoom-out');

    let currentEl = null, umbrellas = [], isDragging = false, isMapPanning = false;
    let currentScale = 1, currentTranslateX = 0, currentTranslateY = 0, minScale = 0.5, maxScale = 3;

    function load() {
      onValue(ref(db, 'umbrellas'), snapshot => {
        const data = snapshot.val() || {};
        umbrellas = [];
        map.innerHTML = '';
        for (const id in data) {
          umbrellas.push(data[id]);
          createUmbrella(data[id]);
        }
      });
    }
    function saveUmbrella(data) { set(ref(db, `umbrellas/${data.id}`), data); }
    function deleteUmbrella(id) { remove(ref(db, `umbrellas/${id}`)); }

    function createUmbrella(data) {
      const el = document.createElement('div');
      el.className = 'umbrella';
      el.dataset.id = data.id;
      el.dataset.lettini = data.lettini;
      el.dataset.open = data.open;
      el.dataset.mtime = data.mtime;
      el.style.left = data.x + 'px';
      el.style.top = data.y + 'px';
      map.appendChild(el);
      render(el);
    }
    function render(el) {
      const lettini = el.dataset.lettini;
      const open = el.dataset.open === 'true';
      const date = new Date(parseInt(el.dataset.mtime || Date.now()));
      el.classList.toggle('open', open);
      el.classList.toggle('closed', !open);
      el.innerHTML = '';
      const deleteBtn = document.createElement('div');
      deleteBtn.className = 'delete-btn'; deleteBtn.title = 'Elimina'; deleteBtn.textContent = '🗑️';
      const dateLabel = document.createElement('div');
      dateLabel.className = 'date-label';
      dateLabel.textContent = date.toLocaleString('it-IT', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
      el.appendChild(deleteBtn);
      el.appendChild(dateLabel);
      el.appendChild(document.createTextNode(lettini));
      addListeners(el);
    }
    function addListeners(el) {
      const deleteBtn = el.querySelector('.delete-btn');
      const handleDelete = (e) => {
        e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
        deleteUmbrella(el.dataset.id);
      };
      deleteBtn.addEventListener('touchstart', e => { e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation(); });
      deleteBtn.addEventListener('touchend', handleDelete);
      deleteBtn.addEventListener('click', handleDelete);

      let touchStartX, touchStartY, elementStartX, elementStartY, hasMoved, touchStartTime;
      el.addEventListener('touchstart', e => {
        if (e.target.closest('.delete-btn')) return;
        e.preventDefault(); e.stopPropagation();
        const touch = e.touches[0];
        touchStartX = touch.clientX; touchStartY = touch.clientY;
        elementStartX = parseInt(el.style.left); elementStartY = parseInt(el.style.top);
        hasMoved = false; touchStartTime = Date.now(); isDragging = false;
      });
      el.addEventListener('touchmove', e => {
        if (e.target.closest('.delete-btn')) return;
        e.preventDefault(); e.stopPropagation();
        const touch = e.touches[0];
        const dx = touch.clientX - touchStartX;
        const dy = touch.clientY - touchStartY;
        if (Math.abs(dx)>5 || Math.abs(dy)>5) {
          hasMoved = true; isDragging = true;
          el.style.left = (elementStartX + dx / currentScale) + 'px';
          el.style.top = (elementStartY + dy / currentScale) + 'px';
        }
      });
      el.addEventListener('touchend', e => {
        if (e.target.closest('.delete-btn')) return;
        e.preventDefault(); e.stopPropagation();
        const duration = Date.now() - touchStartTime;
        if (hasMoved && isDragging) {
          el.dataset.mtime = Date.now();
          updateData(el, true); render(el);
          const idx = umbrellas.findIndex(u => u.id == el.dataset.id);
          if (idx!==-1) saveUmbrella(umbrellas[idx]);
        } else if (!hasMoved && duration < 300) {
          openEditModal(el);
        }
        isDragging = false; hasMoved = false;
      });
      el.addEventListener('mousedown', e => {
        if (e.target.closest('.delete-btn')) return;
        e.preventDefault(); e.stopPropagation();
        const startX = e.clientX, startY = e.clientY;
        const origX = parseInt(el.style.left), origY = parseInt(el.style.top);
        let mouseMoved = false;
        const handleMouseMove = ev => {
          mouseMoved = true; isDragging = true;
          const dx = (ev.clientX - startX) / currentScale;
          const dy = (ev.clientY - startY) / currentScale;
          el.style.left = origX + dx + 'px';
          el.style.top = origY + dy + 'px';
        };
        const handleMouseUp = () => {
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
          if (mouseMoved) {
            el.dataset.mtime = Date.now();
            updateData(el, true); render(el);
            const idx = umbrellas.findIndex(u => u.id == el.dataset.id);
            if (idx!==-1) saveUmbrella(umbrellas[idx]);
          } else {
            openEditModal(el);
          }
          setTimeout(()=>{ isDragging=false; }, 100);
        };
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
      });
    }
    function openEditModal(el) {
      if (isDragging || isMapPanning) return;
      currentEl = el;
      lettiniInput.value = el.dataset.lettini;
      openCheckbox.checked = el.dataset.open === 'true';
      modalBackdrop.style.display = 'flex';
      setTimeout(() => { lettiniInput.focus(); }, 100);
    }
    function updateData(el, posOnly=false) {
      const idx = umbrellas.findIndex(u => u.id == el.dataset.id);
      if (idx===-1) return;
      umbrellas[idx].x = parseInt(el.style.left);
      umbrellas[idx].y = parseInt(el.style.top);
      umbrellas[idx].mtime = parseInt(el.dataset.mtime);
      if (!posOnly) {
        umbrellas[idx].lettini = el.dataset.lettini;
        umbrellas[idx].open = el.dataset.open==='true';
      }
    }

    // 👉 BLOCCO MODIFICATO qui sotto:
    mapContainer.addEventListener('touchend', e => {
      if (e.changedTouches.length === 1) {
        const touch = e.changedTouches[0];
        const target = document.elementFromPoint(touch.clientX, touch.clientY);
        if (!target.closest('.umbrella')
            && !target.closest('#zoom-controls')
            && !modalBackdrop.contains(target)) {
          e.preventDefault();
          if (!isMapPanning) {
            createNewUmbrella(touch.clientX, touch.clientY);
          }
        }
        setTimeout(() => { isMapPanning = false; }, 100);
      }
    });

    mapContainer.addEventListener('mousedown', e => {
      if (e.target === mapContainer) {
        const panStartX = e.clientX, panStartY = e.clientY;
        const panStartTranslateX = currentTranslateX, panStartTranslateY = currentTranslateY;
        document.addEventListener('mousemove', function handle(ev) {
          const dx = (ev.clientX - panStartX) / currentScale;
          const dy = (ev.clientY - panStartY) / currentScale;
          isMapPanning = true;
          currentTranslateX = panStartTranslateX + dx;
          currentTranslateY = panStartTranslateY + dy;
          updateMapTransform();
        });
        document.addEventListener('mouseup', ev => {
          document.removeEventListener('mousemove', handle);
          if (!isMapPanning) {
            createNewUmbrella(ev.clientX, ev.clientY);
          }
          setTimeout(()=>{ isMapPanning=false; },100);
        });
      }
    });

    function updateMapTransform() {
      map.style.transform = `scale(${currentScale}) translate(${currentTranslateX}px, ${currentTranslateY}px)`;
    }
    zoomInBtn.addEventListener('click', () => {
      if (currentScale < maxScale) { currentScale = Math.min(currentScale * 1.2, maxScale); updateMapTransform(); }
    });
    zoomOutBtn.addEventListener('click', () => {
      if (currentScale > minScale) { currentScale = Math.max(currentScale / 1.2, minScale); updateMapTransform(); }
    });

    cancelBtn.addEventListener('click', () => modalBackdrop.style.display='none');
    saveBtn.addEventListener('click', () => {
      if (!currentEl) return;
      currentEl.dataset.lettini = lettiniInput.value || '2';
      currentEl.dataset.open = openCheckbox.checked;
      currentEl.dataset.mtime = Date.now();
      updateData(currentEl);
      render(currentEl);
      const idx = umbrellas.findIndex(u=>u.id==currentEl.dataset.id);
      if(idx!==-1) saveUmbrella(umbrellas[idx]);
      modalBackdrop.style.display = 'none';
      currentEl = null;
    });

    modalBackdrop.addEventListener('click', e => {
      if(e.target === modalBackdrop) modalBackdrop.style.display='none';
    });

    lettiniInput.addEventListener('keypress', e => {
      if(e.key==='Enter') saveBtn.click();
    });

    document.addEventListener('touchstart', e => { if(e.touches.length>1) e.preventDefault(); }, {passive:false});
    document.addEventListener('touchmove', e => { if(e.touches.length>1) e.preventDefault(); }, {passive:false});

    // Funzione per creare nuovo ombrellone
    function createNewUmbrella(clientX, clientY) {
      const mapRect = map.getBoundingClientRect();
      const containerRect = mapContainer.getBoundingClientRect();
      const adjustedX = (clientX - containerRect.left - currentTranslateX * currentScale) / currentScale;
      const adjustedY = (clientY - containerRect.top - currentTranslateY * currentScale) / currentScale;
      const id = Date.now() + Math.random();
      const data = {
        id,
        lettini: '2',
        open: false,
        x: Math.max(0, Math.min(adjustedX - 70, 2000 - 140)),
        y: Math.max(0, Math.min(adjustedY - 70, 2000 - 140)),
        mtime: Date.now()
      };
      umbrellas.push(data);
      createUmbrella(data);
      saveUmbrella(data);
    }

    load();
  </script>
</body>
</html>
